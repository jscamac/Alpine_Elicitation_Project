packages:
  - dplyr
  - tidyr
  - ggplot2

sources:
  - R

plot_options:
  rect35:
    width: 5
    height: 4
  square:
    width: 6
    height: 6
  square8:
    width: 8
    height: 8
  portrait:
    width: 6
    height: 8

targets:
  all:
    depends:
      - figures/raw_answers.pdf
      - figures/cv_plot.pdf
      - figures/stack_plot.pdf
      - figures/adaptive_capacity.pdf
      - figures/community.pdf
      - figures/raw_diffanswers.pdf
      - figures/community_diff.pdf
      - figures/EW_continuous_traits.pdf
      - figures/PW_continuous_traits.pdf
      - figures/EW_environmental_traits.pdf
      - figures/PW_environmental_traits.pdf
      - figures/EW_categorical_traits.pdf
      - figures/PW_categorical_traits.pdf

# ------- data --------------------------

  compiled_data:
    command: compile_data(answers_path = I("raw_data/expert_answers.csv"),
                          metadata_path = I("raw_data/metadata.csv"))
    cleanup_level: purge
    check: exists

  raw_answers:
    command: extract_raw_answers(compiled_data)
    cleanup_level: purge

  raw_differences:
    command: extract_raw_differences(raw_answers)
    cleanup_level: purge

  CV_estimates:
    command: Calculate_CV(raw_answers)
    cleanup_level: purge
    
  adapt_capt:
    command: adaptive_capacity(raw_answers)
    cleanup_level: purge
    
  agreement:
    command: direction_agreement(raw_answers)
    cleanup_level: purge
    
  community_data:
    command: extract_community(compiled_data)
    cleanup_level: purge
    
  comm_differences:
    command: extract_comm_differences(community_data)
    cleanup_level: purge
    
# ------- Distribution samples --------------------------  
  group_samples:
    command: sample_compiler(sample_dir = I("raw_data/group_dist_samples"), 
                             meta_path = I("raw_data/metadata.csv"), 
                             trait_path = I("raw_data/species_traits.csv"))
    cleanup_level: purge
    
# ------- plots --------------------------  

  figures/raw_answers.pdf:
    command: plot_raw_answers(raw_answers)
    plot: square8
    cleanup_level: purge
    
  figures/raw_diffanswers.pdf:
    command: plot_raw_diff(raw_differences)
    plot: square8
    cleanup_level: purge

  figures/cv_plot.pdf:
    command: plot_cv(CV_estimates)
    plot: square8
    cleanup_level: purge
    
  figures/stack_plot.pdf:
    command: plot_stack(agreement)
    plot: square8
    cleanup_level: purge
    
  figures/adaptive_capacity.pdf:
    command: plot_adaptive_capacity(adapt_capt)
    plot: square8
    cleanup_level: purge

  figures/community.pdf:
    command: plot_community(community_data)
    plot: rect35
    cleanup_level: purge
    
  figures/community_diff.pdf:
    command: plot_comm_diff(comm_differences)
    plot: rect35
    cleanup_level: purge

  figures/EW_continuous_traits.pdf:
    command: plot_scatter(data = group_samples,
                          weight_type = I("EW"),
                          response = I("adapt_cap"),
                          predictor = I(c("Mean_ht_mm",
                                          "Leaf_area_mm2",
                                          "SLA_mm2mg1",
                                          "Diaspore_mg",
                                          "Dispersal_dist_m")),
                          predictor_labels = I(c("Mean~ht~(mm)",
                                                 "Leaf~area~(mm^2)",
                                                 "SLA~(mm^{2}*mg^{-1})",
                                                 "Diaspore~(mg)",
                                                 "Dispersal~dist~(m)")),
                          xlab =I("Log10(traits values)"),
                          ylab =I("Adaptive capacity"),
                          alpha = 0.02,
                          ncol=2,
                          zero_line=TRUE,
                          scale=I("free"),
                          logx = TRUE,
                          show_correlation = TRUE,
                          ylimits =I(c(-1,1.25)))
    plot: portrait
    cleanup_level: purge
    
  figures/PW_continuous_traits.pdf:
    command: plot_scatter(data = group_samples,
                          weight_type = I("PW"),
                          response = I("adapt_cap"),
                          predictor = I(c("Mean_ht_mm",
                                          "Leaf_area_mm2",
                                          "SLA_mm2mg1",
                                          "Diaspore_mg",
                                          "Dispersal_dist_m")),
                          predictor_labels = I(c("Mean~ht~(mm)",
                                                 "Leaf~area~(mm^2)",
                                                 "SLA~(mm^{2}*mg^{-1})",
                                                 "Diaspore~(mg)",
                                                 "Dispersal~dist~(m)")),
                          xlab =I("Log10(traits values)"),
                          ylab =I("Adaptive capacity"),
                          alpha = 0.02,
                          ncol=2,
                          zero_line=TRUE,
                          scale=I("free"),
                          logx = TRUE,
                          show_correlation = TRUE,
                          ylimits =I(c(-1,1.25)))
    plot: portrait
    cleanup_level: purge
    
  figures/EW_categorical_traits.pdf:
    command: plot_scatter(data = group_samples,
                          weight_type = I("EW"),
                          response = I("adapt_cap"),
                          predictor = I(c("Growth_form",
                                          "Resprouter",
                                          "Pollination",
                                          "Dispersal_mode")),
                          predictor_labels = I(c("Growth~form",
                                                 "Resprouter",
                                                 "Pollinator",
                                                 "Dispersal~mode")),
                          xlab =I("Categorical traits"),
                          ylab =I("Adaptive capacity"),
                          alpha = 0.02,
                          ncol=2,
                          zero_line= TRUE,
                          scale=I("free"),
                          logx = FALSE)
    plot: square
    cleanup_level: purge
    
  figures/PW_categorical_traits.pdf:
    command: plot_scatter(data = group_samples,
                          weight_type = I("PW"),
                          response = I("adapt_cap"),
                          predictor = I(c("Growth_form",
                                          "Resprouter",
                                          "Pollination",
                                          "Dispersal_mode")),
                          predictor_labels = I(c("Growth~form",
                                                 "Resprouter",
                                                 "Pollinator",
                                                 "Dispersal~mode")),
                          xlab =I("Categorical traits"),
                          ylab =I("Adaptive capacity"),
                          alpha = 0.02,
                          ncol=2,
                          zero_line= TRUE,
                          scale=I("free"),
                          logx = FALSE)
    plot: square
    cleanup_level: purge
    
  figures/EW_environmental_traits.pdf:
    command: plot_scatter(data = group_samples,
                          weight_type = I("EW"),
                          response = I("adapt_cap"),
                          predictor = I(c("altitude_min",
                                          "altitude_max",
                                          "altitude_range",
                                          "MAT_min",
                                          "MAT_max",
                                          "MAT_range",
                                          "Extent",
                                          "Area")),
                          predictor_labels = I(c("Min~altitude~(m)",
                                                 "Max~altitude~(m)",
                                                 "Altitude~range~(m)",
                                                 "Min~MAT~(~degree*C)",
                                                 "Max~MAT~(~degree*C)",
                                                 "MAT~range~(~degree*C)",
                                                 "Extent~occupied~(km^2)",
                                                 "Area~occupied~(km^2)")),
             
                          xlab =I("Environmental traits"),
                          ylab =I("Adaptive capacity"),
                          alpha = 0.02,
                          ncol=2,
                          zero_line=TRUE,
                          scale =I("free"),
                          show_correlation = TRUE,
                          logx = FALSE,
                          ylimits =I(c(-1,1.25)))
    plot: portrait
    cleanup_level: purge
      
  figures/PW_environmental_traits.pdf:
    command: plot_scatter(data = group_samples,
                          weight_type = I("PW"),
                          response = I("adapt_cap"),
                          predictor = I(c("altitude_min",
                                          "altitude_max",
                                          "altitude_range",
                                          "MAT_min",
                                          "MAT_max",
                                          "MAT_range",
                                          "Extent",
                                          "Area")),
                          predictor_labels = I(c("Min~altitude~(m)",
                                                 "Max~altitude~(m)",
                                                 "Altitude~range~(m)",
                                                 "Min~MAT~(~degree*C)",
                                                 "Max~MAT~(~degree*C)",
                                                 "MAT~range~(~degree*C)",
                                                 "Extent~occupied~(km^2)",
                                                 "Area~occupied~(km^2)")),
             
                          xlab =I("Environmental traits"),
                          ylab =I("Adaptive capacity"),
                          alpha = 0.02,
                          ncol=2,
                          zero_line=TRUE,
                          scale =I("free"),
                          show_correlation = TRUE,
                          logx = FALSE,
                          ylimits =I(c(-1,1.25)))
    plot: portrait
    cleanup_level: purge
